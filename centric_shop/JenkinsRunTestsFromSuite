pipeline {
    agent any

    stages {
        stage('Install Dependencies') {
            steps {
                dir('centric_shop') {
                script {
                // Install bundle and change the user
                    sh 'bundle install'
                    sh 'su jenkins'
                }
            }
        }
     }

        stage('Divide Test Cases') {
            steps {
                dir('centric_shop') {
                script {
                    sh 'ruby divide_test_case.rb'
                }
            }
        }
    }

        stage('Run Test Cases') {
            steps {
                dir('centric_shop') {
                script {
                    // Retrieve the list of suites generated by cuke-slicer
                    def suites = sh(returnStdout: true, script: 'ls -1 suite_*.feature').trim().split('\n')
                    println "Feature Files : ${suites}"
                    println "Total Suites : ${suites.size()}"

                    for (int i = 0; i < suites.size(); i++) {
                        def suite = suites[i]
                        def testSuite = readFile "${suite}"
                        //def testSuite = fileContent

                        println "Running tests with feature file ${testSuite} from ${suite}"
                        def testExitCode = sh script: "bundle exec cucumber ${testSuite} --tags '@functional'", returnStatus: true
                        echo "Test Exit Code: ${testExitCode}"
                        if (testExitCode != 0) {
                            echo "Some tests failed in ${suite} from ${testSuite}, but continuing..."
                        }
                    }
                }
            }
        }}
        post {
            success {
                echo "All stages executed successfully..."
            }
        }
    }
}
