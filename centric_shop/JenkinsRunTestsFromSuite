pipeline {
    agent any

    stages {
        stage('Install Dependencies') {
            steps {
                dir('centric_shop') {
                script {
                // Install bundle and change the user
                    sh 'bundle install'
                    sh 'su jenkins'
                }
            }
        }
     }

        stage('Divide Test Cases') {
            steps {
                dir('centric_shop') {
                script {
                    sh 'ruby divide_test_case.rb'
                }
            }
        }
    }

        stage('Run Test Cases') {
            steps {
                dir('centric_shop') {
                script {
                    // Retrieve the list of suites generated by cuke-slicer
                    def suites = sh(returnStdout: true, script: 'ls -1 suite_*.feature').trim().split('\n')
                    println "Feature Files : ${suites}"
                    println "Total Suites : ${suites.size()}"

                    for (int i = 0; i < suites.size(); i++) {
                        def suite = suites[i]
                        def testSuite = readFile "${suite}"
                        //def testSuite = fileContent

                        println "Running tests with feature file ${testSuite} from ${suite}"
                        def testExitCode = sh script: "bundle exec cucumber ${testSuite} --tags '@functional'", returnStatus: true
                        echo "Test Exit Code: ${testExitCode}"
                        if (testExitCode != 0) {
                            echo "Some tests failed in ${suite} from ${testSuite}, but continuing..."
                        }
                    }
                }
            }
        }}

        stage('Create Test Suites Again'){
            steps {
                dir('centric_shop'){
                    script {
                      // Retrieve the list of suites generated by cuke-slicer
                      def suites = sh(returnStdout: true, script: 'ls -1 suite_*.feature').trim().split('\n')

                      // Divide the suites into two groups
                      def group1 = suites[0..suites.size()/2-1]
                      echo "Group 1 : ${group1}"
                      def group2 = suites[suites.size()/2..-1]
                      echo "Group 2: ${group2}"

                      // Store the suite groupings as environment variables
                      env.GROUP1 = group1.join(',')
                      echo "${env.GROUP1}"
                      env.GROUP2 = group2.join(',')
                      echo "${env.GROUP2}"
                    }
                }
            }
        }

        stage('Run Test Suites in Parallel') {
            parallel {
                stage('Suite 1'){
                    // agent { label 'slave1' }
                    steps {
                        script {
                            // Retrieve the suite group 1 from environment variable
                            def suitesGroup1 = env.GROUP1.split(',')
                            // Run the test cases from suite group 1 on the Jenkins slave
                            for (def suite : suitesGroup1) {
                                def testExitCode = sh script: "bundle exec cucumber ${suite} --tags '@functional'", returnStatus: true
                                echo "Test Exit Code: ${testExitCode}"
                                if (testExitCode != 0) {
                                    // echo "Some tests failed in ${suite} from ${testSuite}, but continuing..."
                                    echo "Continuing..."
                                }
                            }
                        }
                    }
                }
                stage('Suite 2'){
                    // agent { label 'slave2' }
                    steps {
                        script {
                            // Retrieve the suite group 2 from environment variable
                            def suitesGroup2 = env.GROUP2.split(',')
                            // Run the test cases from suite group 1 on the Jenkins slave
                            for (def suite : suitesGroup2) {
                                def testExitCode = sh script: "bundle exec cucumber ${suite} --tags '@functional'", returnStatus: true
                                echo "Test Exit Code: ${testExitCode}"
                                if (testExitCode != 0) {
                                    // echo "Some tests failed in ${suite} from ${testSuite}, but continuing..."
                                    echo "Continuing..."
                                }
                            }
                        }
                    }
                }
            }
        }
        post {
            success {
                echo "All stages executed successfully..."
            }
        }
    }
}
