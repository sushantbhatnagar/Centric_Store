pipeline {
  agent any

  stages {
      stage('Install Dependencies') {
        steps {
          dir('centric_shop') {
          script {
            // Install bundle and change the user
            sh 'bundle install'
            sh 'su jenkins'
           }
         }
       }
     }

    stage('Divide Test Cases') {
      steps {
        dir('centric_shop') {
        script {
          sh 'ruby divide_test_case.rb'
         }
        }
      }
    }

    stage('Run Test Cases') {
      steps {
        dir('centric_shop') {
        script {
          // Retrieve the list of suites generated by cuke-slicer
          def suites = sh(returnStdout: true, script: 'ls -1 suite_*.feature').trim().split('\n')
          println "${suites}"
          println "Total Suites : ${suites.size()}"

          for (int i = 0; i < suites.size(); i++) {
            def suite = suites[i]
            def testSuite = readFile "${suite}"
            //def testSuite = fileContent

            println "Running tests with feature file ${testSuite} from ${suite}"
            sh "cucumber ${testSuite} --tags '@functional'"
           }
         }
       }
     }
   }
  }
}
